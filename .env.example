# ============================================================================
# SQL Server to PostgreSQL CDC Pipeline - Configuration
# ============================================================================
# Copy this file to .env and customize for your environment
# NEVER commit the .env file to version control
#
# This configuration supports BOTH:
# - Environment variable substitution: ${ENV_VAR}
# - Vault secret placeholders: ${vault:secret/path:key}
#
# Priority: Vault secrets take precedence over environment variables
# ============================================================================

# ============================================================================
# DATABASE CONNECTIONS
# ============================================================================

# SQL Server (Source Database)
SQLSERVER_HOST=sqlserver
SQLSERVER_PORT=1433
SQLSERVER_DATABASE=warehouse_source
SQLSERVER_USER=sa
SQLSERVER_PASSWORD=YourStrong!Passw0rd
SQLSERVER_AGENT_ENABLED=true

# PostgreSQL (Target Database)
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=warehouse_target
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres_secure_password

# ============================================================================
# DEBEZIUM SOURCE CONNECTOR - DATA FLOW PARAMETERS
# ============================================================================

# Task Parallelism
# NOTE: SQL Server CDC connector MUST use tasks.max=1 due to single-threaded
# transaction log reading. Multiple tasks would cause data inconsistency:
# - Out-of-order event processing
# - Duplicate events
# - Transaction boundary violations
#
# SQL Server CDC uses the database transaction log which is inherently
# sequential. Debezium reads this log in a single-threaded manner to
# maintain transaction ordering and consistency.
#
# DO NOT CHANGE THIS VALUE unless you know what you're doing.
# Reference: https://debezium.io/documentation/reference/connectors/sqlserver.html
DEBEZIUM_TASKS_MAX=1

# Batch Processing
# Controls how many records are batched together for processing
# Higher values = better throughput, higher memory usage
# Range: 100-8192, Default: 2048
# Tuning: Low latency=512, Balanced=2048, High throughput=4096
DEBEZIUM_MAX_BATCH_SIZE=2048

# Queue Size
# Internal queue size for buffering change events
# Higher values = more memory, better burst handling
# Range: 1024-16384, Default: 8192
# Tuning: Low volume=2048, Balanced=8192, Bursty=16384
DEBEZIUM_MAX_QUEUE_SIZE=8192

# Polling Interval
# How often (in milliseconds) to poll the transaction log
# Lower values = lower latency, higher CPU usage
# Range: 100-5000ms, Default: 500ms
# Tuning: Low latency=100ms, Balanced=500ms, High throughput=1000ms
DEBEZIUM_POLL_INTERVAL_MS=500

# Database Configuration
DEBEZIUM_DATABASE_NAMES=warehouse_source
DEBEZIUM_TABLE_INCLUDE_LIST=dbo.customers,dbo.orders,dbo.line_items,dbo.schema_test,dbo.test_customers,dbo.perf_test

# Snapshot Configuration
# Options: initial, schema_only, initial_only, never
# - initial: Full snapshot then CDC (slowest startup, complete data)
# - schema_only: Skip snapshot, CDC only (fastest startup, requires pre-existing CDC)
# - initial_only: Snapshot only, no CDC (one-time data migration)
# - never: No snapshot (use for active CDC tables)
# Default: schema_only (fastest for existing CDC setups)
DEBEZIUM_SNAPSHOT_MODE=schema_only

# Snapshot Locking Mode
# Options: minimal, exclusive, none
# - minimal: Minimal locking during snapshot
# - exclusive: Exclusive table locks (safest, slowest)
# - none: No locking (fastest, use with schema_only)
# Default: none
DEBEZIUM_SNAPSHOT_LOCKING_MODE=none

# Topic Configuration
DEBEZIUM_TOPIC_PREFIX=sqlserver
DEBEZIUM_SCHEMA_HISTORY_TOPIC=schema-changes.warehouse_source

# ============================================================================
# POSTGRESQL SINK CONNECTOR - DATA FLOW PARAMETERS
# ============================================================================

# Task Parallelism
# Number of parallel tasks for sink connector
# Higher values = better throughput for multi-table scenarios
# Range: 1-10, Default: 3
# Tuning: Low volume=1, Balanced=3, High volume=5, Many tables=5-10
SINK_TASKS_MAX=3

# Batch Processing
# Number of records to batch before writing to PostgreSQL
# Higher values = better throughput, higher latency
# Range: 100-5000, Default: 3000
# Tuning: Low latency=1000, Balanced=3000, High throughput=5000
SINK_BATCH_SIZE=3000

# Connection Pool
# Size of JDBC connection pool
# Should be >= SINK_TASKS_MAX for optimal performance
# Range: 1-20, Default: 10
# Recommendation: SINK_TASKS_MAX + buffer (e.g., 3 tasks = 10 pool)
SINK_CONNECTION_POOL_SIZE=10

# Connection Retry Configuration
# Number of retry attempts for failed connections
# Range: 1-100, Default: 10
SINK_CONNECTION_ATTEMPTS=10

# Backoff between connection retry attempts (milliseconds)
# Range: 1000-30000ms, Default: 5000ms
SINK_CONNECTION_BACKOFF_MS=5000

# Error Handling
# Total retry timeout for failed operations (milliseconds)
# 300000ms = 5 minutes
# Range: 60000-3600000ms (1min-1hr), Default: 300000ms
SINK_ERRORS_RETRY_TIMEOUT=300000

# Maximum delay between retry attempts (milliseconds)
# Uses exponential backoff up to this max
# Range: 10000-300000ms, Default: 60000ms (1 minute)
SINK_ERRORS_RETRY_DELAY_MAX_MS=60000

# Topic Configuration
# Comma-separated list of Kafka topics to consume
# Pattern: ${DEBEZIUM_TOPIC_PREFIX}.${DEBEZIUM_DATABASE_NAMES}.schema.table
SINK_TOPICS=sqlserver.warehouse_source.dbo.customers,sqlserver.warehouse_source.dbo.orders,sqlserver.warehouse_source.dbo.line_items,sqlserver.warehouse_source.dbo.schema_test,sqlserver.warehouse_source.dbo.test_customers

# Dead Letter Queue Configuration
# Failed messages are sent to DLQ for later analysis
SINK_DLQ_TOPIC_NAME=dlq-postgresql-sink
SINK_DLQ_REPLICATION_FACTOR=1

# ============================================================================
# KAFKA INFRASTRUCTURE
# ============================================================================

KAFKA_BROKER=kafka:9092
KAFKA_INTERNAL_LISTENERS=PLAINTEXT://0.0.0.0:9092
KAFKA_EXTERNAL_LISTENERS=PLAINTEXT://localhost:29092
KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181

# Topic Configuration
KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
KAFKA_NUM_PARTITIONS=3
KAFKA_DEFAULT_REPLICATION_FACTOR=1  # Set to 3 in production

# ============================================================================
# SCHEMA REGISTRY
# ============================================================================

SCHEMA_REGISTRY_HOST=schema-registry
SCHEMA_REGISTRY_PORT=8081
SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS=kafka:9092

# ============================================================================
# KAFKA CONNECT
# ============================================================================

CONNECT_BOOTSTRAP_SERVERS=kafka:9092
CONNECT_REST_PORT=8083
CONNECT_GROUP_ID=cdc-connect-cluster
CONNECT_CONFIG_STORAGE_TOPIC=connect-configs
CONNECT_OFFSET_STORAGE_TOPIC=connect-offsets
CONNECT_STATUS_STORAGE_TOPIC=connect-status
CONNECT_KEY_CONVERTER=io.confluent.connect.avro.AvroConverter
CONNECT_VALUE_CONVERTER=io.confluent.connect.avro.AvroConverter
CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL=http://schema-registry:8081
CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL=http://schema-registry:8081

# Connector plugins
CONNECT_PLUGIN_PATH=/usr/share/java,/usr/share/confluent-hub-components

# ============================================================================
# HASHICORP VAULT
# ============================================================================

VAULT_ADDR=http://vault:8200
VAULT_DEV_ROOT_TOKEN_ID=dev-root-token
VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
VAULT_API_ADDR=http://vault:8200

# Vault secrets engine
VAULT_SECRETS_ENGINE=secret
VAULT_SECRETS_PATH=database

# ============================================================================
# MONITORING & OBSERVABILITY
# ============================================================================

# Prometheus
PROMETHEUS_PORT=9090
PROMETHEUS_SCRAPE_INTERVAL=15s
PROMETHEUS_EVALUATION_INTERVAL=15s

# Grafana
GRAFANA_PORT=3000
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin_secure_password
GRAFANA_ALLOW_SIGNUP=false
GRAFANA_DISABLE_GRAVATAR=true

# Jaeger
JAEGER_AGENT_PORT=6831
JAEGER_COLLECTOR_PORT=14268
JAEGER_QUERY_PORT=16686
JAEGER_SAMPLING_RATE=1.0  # 1.0 = 100% sampling for dev, reduce in production

# ============================================================================
# OPERATIONAL SETTINGS
# ============================================================================

# Reconciliation
RECONCILIATION_SCHEDULE_CRON=0 2 * * *  # Daily at 2 AM
RECONCILIATION_BATCH_SIZE=10000
RECONCILIATION_PARALLEL_TABLES=5

# Alerting thresholds
ALERT_REPLICATION_LAG_SECONDS=300  # 5 minutes
ALERT_ERROR_RATE_PERCENT=5  # 5% error rate threshold
ALERT_CONNECTOR_DOWN_MINUTES=5

# Resource limits
MAX_MEMORY_GB=4
MAX_CPU_CORES=2

# ============================================================================
# DEVELOPMENT/TEST SETTINGS
# ============================================================================

# Set to 'true' to enable debug logging
DEBUG_MODE=false
LOG_LEVEL=INFO

# Test data settings
TEST_SAMPLE_SIZE=10000
TEST_BULK_INSERT_SIZE=10000

# ============================================================================
# PERFORMANCE TUNING QUICK REFERENCE
# ============================================================================
#
# Scenario: Low Latency, Low Volume
# - DEBEZIUM_MAX_BATCH_SIZE=512
# - DEBEZIUM_MAX_QUEUE_SIZE=2048
# - DEBEZIUM_POLL_INTERVAL_MS=100
# - SINK_BATCH_SIZE=1000
# - SINK_TASKS_MAX=1
#
# Scenario: Balanced (Default)
# - DEBEZIUM_MAX_BATCH_SIZE=2048
# - DEBEZIUM_MAX_QUEUE_SIZE=8192
# - DEBEZIUM_POLL_INTERVAL_MS=500
# - SINK_BATCH_SIZE=3000
# - SINK_TASKS_MAX=3
#
# Scenario: High Throughput
# - DEBEZIUM_MAX_BATCH_SIZE=4096
# - DEBEZIUM_MAX_QUEUE_SIZE=16384
# - DEBEZIUM_POLL_INTERVAL_MS=1000
# - SINK_BATCH_SIZE=5000
# - SINK_TASKS_MAX=5
#
# Scenario: Bursty Workload
# - DEBEZIUM_MAX_BATCH_SIZE=2048
# - DEBEZIUM_MAX_QUEUE_SIZE=16384  # Larger queue for bursts
# - DEBEZIUM_POLL_INTERVAL_MS=500
# - SINK_BATCH_SIZE=3000
# - SINK_TASKS_MAX=3
#
# For detailed tuning guidance, see docs/CONNECTOR_CONFIGURATION.md
# ============================================================================
